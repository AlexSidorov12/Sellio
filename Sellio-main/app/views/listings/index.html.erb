<% content_for :title, "Sell.io - Buy & Sell Anything" %>

<% if notice %>
  <div class="alert alert-success"><%= notice %></div>
<% end %>

<div class="homepage">
  <!-- Hero Section with Search (only show on homepage) -->
  <% unless params[:category_id].present? || params[:search].present? %>
  <section class="hero-section">
    <div class="hero-content">
      <h1 class="hero-title">Buy & Sell Anything</h1>
      <p class="hero-subtitle">Free classified ads in your area</p>
      
      <% unless user_signed_in? %>
        <div class="auth-buttons-hero">
          <%= link_to "Login", new_user_session_path, class: "btn-hero btn-login" %>
          <%= link_to "Sign Up", new_user_registration_path, class: "btn-hero btn-signup-hero" %>
        </div>
      <% end %>
      
      <div class="search-box">
        <%= form_with url: listings_path, method: :get, local: true, class: "search-form" do |f| %>
          <div class="search-input-group">
            <%= f.text_field :search, placeholder: "What are you looking for?", class: "search-input" %>
            <%= f.text_field :location, placeholder: "Location (e.g., Dublin)", class: "search-input location-input" %>
            <%= f.submit "Search", class: "search-button" %>
          </div>
        <% end %>
      </div>
    </div>
  </section>
  <% end %>

  <!-- Car Filter Section (only show on homepage) -->
  <% unless params[:category_id].present? || params[:search].present? %>
  <% motors_category = Category.find_by("name ILIKE ?", "%motor%") %>
  <% if motors_category %>
  <section class="car-filter-section">
    <div class="container">
      <div class="car-filter-box">
        <h2 class="car-filter-title">Looking for a new car?</h2>
        <%= form_with url: listings_path, method: :get, local: true, class: "car-filter-form" do |f| %>
          <%= f.hidden_field :category_id, value: motors_category.id %>
          <div class="car-filter-grid">
            <div class="car-filter-field">
              <%= f.label :make, "All Makes" %>
              <%= f.select :make, options_for_select([
                ['All Makes', ''],
                ['Alfa Romeo', 'Alfa Romeo'],
                ['Aston Martin', 'Aston Martin'],
                ['Audi', 'Audi'],
                ['Bentley', 'Bentley'],
                ['BMW', 'BMW'],
                ['Chevrolet', 'Chevrolet'],
                ['Chrysler', 'Chrysler'],
                ['Citroen', 'Citroen'],
                ['Dacia', 'Dacia'],
                ['Dodge', 'Dodge'],
                ['Ferrari', 'Ferrari'],
                ['Fiat', 'Fiat'],
                ['Ford', 'Ford'],
                ['Honda', 'Honda'],
                ['Hyundai', 'Hyundai'],
                ['Infiniti', 'Infiniti'],
                ['Jaguar', 'Jaguar'],
                ['Jeep', 'Jeep'],
                ['Kia', 'Kia'],
                ['Lamborghini', 'Lamborghini'],
                ['Land Rover', 'Land Rover'],
                ['Lexus', 'Lexus'],
                ['Maserati', 'Maserati'],
                ['Mazda', 'Mazda'],
                ['McLaren', 'McLaren'],
                ['Mercedes-Benz', 'Mercedes-Benz'],
                ['Mini', 'Mini'],
                ['Mitsubishi', 'Mitsubishi'],
                ['Nissan', 'Nissan'],
                ['Opel', 'Opel'],
                ['Peugeot', 'Peugeot'],
                ['Porsche', 'Porsche'],
                ['Renault', 'Renault'],
                ['Rolls-Royce', 'Rolls-Royce'],
                ['Seat', 'Seat'],
                ['Skoda', 'Skoda'],
                ['Smart', 'Smart'],
                ['Subaru', 'Subaru'],
                ['Suzuki', 'Suzuki'],
                ['Tesla', 'Tesla'],
                ['Toyota', 'Toyota'],
                ['Vauxhall', 'Vauxhall'],
                ['Volkswagen', 'Volkswagen'],
                ['Volvo', 'Volvo']
              ], params[:make]), {}, { class: "car-filter-select", id: "car_make_select" } %>
            </div>
            <div class="car-filter-field">
              <%= f.label :model, "All Models" %>
              <%= f.select :model, options_for_select([['All Models', '']], params[:model]), {}, { class: "car-filter-select", id: "car_model_select" } %>
            </div>
            <div class="car-filter-field">
              <%= f.label :min_year, "Min Year" %>
              <%= f.select :min_year, options_for_select([['Min Year', '']] + (1990..Date.current.year).to_a.reverse.map { |y| [y, y] }, params[:min_year]), {}, { class: "car-filter-select" } %>
            </div>
            <div class="car-filter-field">
              <%= f.label :max_year, "Max Year" %>
              <%= f.select :max_year, options_for_select([['Max Year', '']] + (1990..Date.current.year).to_a.reverse.map { |y| [y, y] }, params[:max_year]), {}, { class: "car-filter-select" } %>
            </div>
            <div class="car-filter-field">
              <%= f.label :min_price, "Min Price" %>
              <%= f.number_field :min_price, placeholder: "Min Price", class: "car-filter-input", min: 0, step: 100 %>
            </div>
            <div class="car-filter-field">
              <%= f.label :max_price, "Max Price" %>
              <%= f.number_field :max_price, placeholder: "Max Price", class: "car-filter-input", min: 0, step: 100 %>
            </div>
          </div>
          <% car_count = Listing.where(category_id: motors_category.id).count %>
          <%= f.submit "Search #{number_with_delimiter(car_count)} Cars", class: "car-filter-button" %>
        <% end %>
      </div>
    </div>
  </section>
  
  <script>
    // Comprehensive car make-model relationships
    const carModels = {
      'Audi': ['A1', 'A3', 'A4', 'A5', 'A6', 'A7', 'A8', 'Q2', 'Q3', 'Q5', 'Q7', 'Q8', 'TT', 'R8', 'e-tron', 'e-tron GT', 'RS3', 'RS4', 'RS5', 'RS6', 'RS7', 'S3', 'S4', 'S5', 'S6', 'S7', 'S8'],
      'BMW': ['1 Series', '2 Series', '3 Series', '4 Series', '5 Series', '6 Series', '7 Series', '8 Series', 'X1', 'X2', 'X3', 'X4', 'X5', 'X6', 'X7', 'Z4', 'i3', 'i4', 'iX', 'iX3', 'M2', 'M3', 'M4', 'M5', 'M8', 'X3 M', 'X4 M', 'X5 M', 'X6 M'],
      'Mercedes-Benz': ['A-Class', 'B-Class', 'C-Class', 'E-Class', 'S-Class', 'CLA', 'CLS', 'GLA', 'GLB', 'GLC', 'GLE', 'GLS', 'SL', 'AMG GT', 'EQC', 'EQS', 'EQE', 'C63 AMG', 'E63 AMG', 'S63 AMG', 'G63 AMG'],
      'Volkswagen': ['Golf', 'Polo', 'Passat', 'Jetta', 'Tiguan', 'Touareg', 'Arteon', 'T-Cross', 'T-Roc', 'ID.3', 'ID.4', 'ID.5', 'ID.Buzz', 'Beetle', 'Up!', 'Scirocco', 'Sharan', 'Touran', 'Amarok', 'Caddy'],
      'Ford': ['Fiesta', 'Focus', 'Mondeo', 'Kuga', 'Edge', 'Explorer', 'Mustang', 'Puma', 'EcoSport', 'Ranger', 'Transit', 'S-Max', 'Galaxy', 'Tourneo', 'Fusion', 'Escape', 'Expedition', 'F-150'],
      'Toyota': ['Aygo', 'Yaris', 'Corolla', 'Camry', 'Prius', 'C-HR', 'RAV4', 'Highlander', 'Land Cruiser', 'Hilux', 'Proace', 'Avensis', 'Auris', 'Verso', 'GT86', 'Supra', 'bZ4X'],
      'Honda': ['Civic', 'Accord', 'CR-V', 'HR-V', 'Pilot', 'Fit', 'Insight', 'Ridgeline', 'Passport', 'Odyssey', 'e', 'CR-Z', 'NSX'],
      'Hyundai': ['i10', 'i20', 'i30', 'Elantra', 'Sonata', 'Tucson', 'Santa Fe', 'Kona', 'Ioniq', 'Palisade', 'Venue', 'Nexo', 'IONIQ 5', 'IONIQ 6', 'Genesis', 'Veloster', 'Accent'],
      'Nissan': ['Micra', 'Sentra', 'Altima', 'Maxima', 'Juke', 'Qashqai', 'X-Trail', 'Pathfinder', 'Armada', 'Leaf', 'Ariya', '370Z', 'GT-R', 'Navara', 'Note', 'Pulsar'],
      'Renault': ['Clio', 'Megane', 'Scenic', 'Kadjar', 'Captur', 'Koleos', 'Talisman', 'Zoe', 'Twingo', 'Kangoo', 'Trafic', 'Master', 'Arkana', 'Austral'],
      'Peugeot': ['108', '208', '308', '508', '2008', '3008', '5008', 'Partner', 'Expert', 'Boxer', 'Rifter', 'Traveller', 'e-208', 'e-2008'],
      'Citroen': ['C1', 'C3', 'C4', 'C5', 'Berlingo', 'Cactus', 'C4 Picasso', 'Grand C4 Picasso', 'SpaceTourer', 'Jumper', 'e-C4', 'Ami'],
      'Skoda': ['Fabia', 'Octavia', 'Superb', 'Kodiaq', 'Karoq', 'Kamiq', 'Scala', 'Enyaq', 'Rapid', 'Yeti'],
      'Seat': ['Ibiza', 'Leon', 'Ateca', 'Tarraco', 'Arona', 'Formentor', 'Alhambra', 'Altea', 'Toledo', 'Cupra Born', 'Cupra Formentor'],
      'Mazda': ['Mazda2', 'Mazda3', 'Mazda6', 'CX-3', 'CX-5', 'CX-9', 'CX-30', 'MX-5', 'MX-30', 'BT-50'],
      'Kia': ['Picanto', 'Rio', 'Ceed', 'Optima', 'Sportage', 'Sorento', 'Stonic', 'Niro', 'EV6', 'Soul', 'Seltos', 'Telluride', 'Carnival', 'Stinger'],
      'Volvo': ['V40', 'V60', 'V90', 'XC40', 'XC60', 'XC90', 'S60', 'S90', 'C30', 'C70', 'XC70', 'EX30', 'EX90'],
      'Opel': ['Corsa', 'Astra', 'Insignia', 'Crossland', 'Grandland', 'Mokka', 'Adam', 'Karl', 'Combo', 'Vivaro', 'Movano', 'Corsa-e', 'Mokka-e'],
      'Vauxhall': ['Corsa', 'Astra', 'Insignia', 'Crossland', 'Grandland', 'Mokka', 'Adam', 'Karl', 'Combo', 'Vivaro', 'Movano', 'Corsa-e', 'Mokka-e'],
      'Fiat': ['500', 'Panda', 'Punto', 'Tipo', '500X', '500L', 'Doblo', 'Qubo', 'Talento', 'Ducato', '500e'],
      'Suzuki': ['Swift', 'Vitara', 'S-Cross', 'Jimny', 'Ignis', 'SX4', 'Baleno', 'Celerio', 'Across'],
      'Mitsubishi': ['Mirage', 'Lancer', 'Outlander', 'ASX', 'Eclipse Cross', 'Shogun', 'Pajero', 'i-MiEV'],
      'Subaru': ['Impreza', 'Legacy', 'Outback', 'Forester', 'XV', 'BRZ', 'Ascent', 'WRX', 'Levorg'],
      'Jaguar': ['XE', 'XF', 'XJ', 'F-Pace', 'E-Pace', 'I-Pace', 'F-Type', 'XK', 'X-Type'],
      'Land Rover': ['Discovery', 'Discovery Sport', 'Range Rover', 'Range Rover Sport', 'Range Rover Evoque', 'Defender', 'Range Rover Velar'],
      'Lexus': ['IS', 'ES', 'GS', 'LS', 'NX', 'RX', 'UX', 'GX', 'LX', 'LC', 'RC', 'CT'],
      'Porsche': ['911', '718', 'Panamera', 'Macan', 'Cayenne', 'Taycan', 'Boxster', 'Cayman'],
      'Tesla': ['Model 3', 'Model S', 'Model X', 'Model Y', 'Roadster', 'Cybertruck'],
      'Mini': ['Hatch', 'Clubman', 'Countryman', 'Convertible', 'Paceman', 'Coupe', 'Roadster'],
      'Smart': ['Fortwo', 'Forfour', 'EQ Fortwo', 'EQ Forfour'],
      'Dacia': ['Sandero', 'Duster', 'Logan', 'Lodgy', 'Dokker', 'Spring'],
      'Chevrolet': ['Spark', 'Cruze', 'Malibu', 'Equinox', 'Tahoe', 'Silverado', 'Traverse', 'Blazer', 'Camaro', 'Corvette', 'Bolt'],
      'Chrysler': ['300', 'Pacifica', 'Voyager', 'Grand Caravan'],
      'Dodge': ['Charger', 'Challenger', 'Durango', 'Journey', 'Grand Caravan', 'Ram'],
      'Jeep': ['Renegade', 'Compass', 'Cherokee', 'Grand Cherokee', 'Wrangler', 'Gladiator', 'Wagoneer'],
      'Alfa Romeo': ['Giulia', 'Stelvio', '4C', 'Giulietta', 'Mito', '159', 'Brera'],
      'Aston Martin': ['DB11', 'Vantage', 'DBS', 'DBX', 'Rapide', 'Vanquish'],
      'Bentley': ['Continental', 'Flying Spur', 'Bentayga', 'Mulsanne'],
      'Ferrari': ['488', 'F8', 'Roma', 'Portofino', 'SF90', '812', 'GTC4Lusso', 'LaFerrari'],
      'Lamborghini': ['Huracan', 'Aventador', 'Urus', 'Gallardo'],
      'Maserati': ['Ghibli', 'Quattroporte', 'Levante', 'GranTurismo', 'MC20'],
      'McLaren': ['540C', '570S', '720S', 'GT', 'Artura', 'P1', '650S'],
      'Rolls-Royce': ['Ghost', 'Wraith', 'Dawn', 'Cullinan', 'Phantom'],
      'Infiniti': ['Q30', 'Q50', 'Q60', 'QX30', 'QX50', 'QX60', 'QX80', 'Q70']
    };

    document.addEventListener('DOMContentLoaded', function() {
      const makeSelect = document.getElementById('car_make_select');
      const modelSelect = document.getElementById('car_model_select');
      
      if (makeSelect && modelSelect) {
        // Initialize models based on current make selection
        updateModels();
        
        // Update models when make changes
        makeSelect.addEventListener('change', function() {
          updateModels();
        });
      }
      
      function updateModels() {
        const selectedMake = makeSelect.value;
        const currentModel = modelSelect.value;
        
        // Clear existing options
        modelSelect.innerHTML = '<option value="">All Models</option>';
        
        if (selectedMake && carModels[selectedMake]) {
          // Add models for selected make
          carModels[selectedMake].forEach(function(model) {
            const option = document.createElement('option');
            option.value = model;
            option.textContent = model;
            if (model === currentModel) {
              option.selected = true;
            }
            modelSelect.appendChild(option);
          });
        } else {
          // If no make selected or make not in list, show all models
          const allModels = [];
          Object.values(carModels).forEach(function(models) {
            models.forEach(function(model) {
              if (!allModels.includes(model)) {
                allModels.push(model);
              }
            });
          });
          allModels.sort().forEach(function(model) {
            const option = document.createElement('option');
            option.value = model;
            option.textContent = model;
            if (model === currentModel) {
              option.selected = true;
            }
            modelSelect.appendChild(option);
          });
        }
      }
    });
  </script>
  <% end %>
  <% end %>

  <!-- Categories Section (only show on homepage, not on filtered listings page) -->
  <% unless params[:category_id].present? || params[:search].present? %>
  <section class="categories-section">
    <div class="container">
      <h2 class="section-title">Browse by Category</h2>
      <div class="categories-grid">
        <% if @categories && @categories.any? %>
          <% @categories.each do |category| %>
            <%= link_to "/listings?category_id=#{category.id}", class: "category-card", data: { turbo: false } do %>
              <div class="category-icon"><%= category.icon || "üì¶" %></div>
              <h3><%= category.name %></h3>
              <p><%= category.description || "Browse #{category.name} listings" %></p>
            <% end %>
          <% end %>
        <% else %>
          <!-- Fallback categories if none in database - link by category name -->
          <%= link_to listings_path(search: "Motors"), class: "category-card" do %>
            <div class="category-icon">üöó</div>
            <h3>Motors</h3>
            <p>Cars, Vans, Motorcycles</p>
          <% end %>
          <%= link_to listings_path(search: "Property"), class: "category-card" do %>
            <div class="category-icon">üè†</div>
            <h3>Property</h3>
            <p>Houses, Apartments, Land</p>
          <% end %>
          <%= link_to listings_path(search: "Jobs"), class: "category-card" do %>
            <div class="category-icon">üíº</div>
            <h3>Jobs</h3>
            <p>Full-time, Part-time, Contract</p>
          <% end %>
          <%= link_to listings_path(search: "Electronics"), class: "category-card" do %>
            <div class="category-icon">üì±</div>
            <h3>Electronics</h3>
            <p>Phones, Computers, TVs</p>
          <% end %>
          <%= link_to listings_path(search: "Furniture"), class: "category-card" do %>
            <div class="category-icon">ü™ë</div>
            <h3>Furniture</h3>
            <p>Home & Garden</p>
          <% end %>
          <%= link_to listings_path(search: "Fashion"), class: "category-card" do %>
            <div class="category-icon">üëï</div>
            <h3>Fashion</h3>
            <p>Clothing & Accessories</p>
          <% end %>
          <%= link_to listings_path(search: "Hobbies"), class: "category-card" do %>
            <div class="category-icon">üéÆ</div>
            <h3>Hobbies</h3>
            <p>Sports, Games, Books</p>
          <% end %>
          <%= link_to listings_path(search: "Pets"), class: "category-card" do %>
            <div class="category-icon">üêæ</div>
            <h3>Pets</h3>
            <p>Dogs, Cats, Birds</p>
          <% end %>
          <%= link_to listings_path(search: "Services"), class: "category-card" do %>
            <div class="category-icon">üîß</div>
            <h3>Services</h3>
            <p>Babysitting, Car Valeting, Cleaning</p>
          <% end %>
        <% end %>
      </div>
    </div>
  </section>
  <% end %>

  <!-- Featured Listings Section -->
  <section class="listings-section">
    <div class="container">
      <div class="section-header">
        <% if @selected_category %>
          <h2 class="section-title"><%= @selected_category.name %> Listings</h2>
        <% elsif params[:category_id].present? || params[:search].present? %>
          <h2 class="section-title">Search Results</h2>
        <% else %>
          <h2 class="section-title">Latest Ads</h2>
        <% end %>
        <%= link_to "View All", listings_path, class: "view-all-link" %>
      </div>
      
      <% if @listings.any? %>
        <% if @selected_category || params[:category_id].present? || params[:search].present? %>
          <p class="filter-info" style="margin-bottom: 1.5rem; color: #666; font-size: 0.9375rem;">
            Showing <%= @listings.count %> <%= @listings.count == 1 ? 'listing' : 'listings' %>
            <% if @selected_category %>
              in <%= @selected_category.name %>
            <% end %>
          </p>
        <% end %>
        <div class="listings-grid">
          <% (@selected_category || params[:category_id].present? || params[:search].present? ? @listings : @listings.limit(12)).each do |listing| %>
            <div class="listing-card">
              <%= link_to listing, class: "listing-card-link" do %>
                <div class="listing-image">
                  <% if listing.images.attached? %>
                    <%= image_tag listing.images.first, class: "listing-card-image" %>
                  <% else %>
                    <div class="image-placeholder">
                      <span>üì∑</span>
                    </div>
                  <% end %>
                </div>
                <div class="listing-content">
                  <h3 class="listing-title">
                    <%= listing.title %>
                  </h3>
                  <p class="listing-location">üìç <%= listing.city || "Location not specified" %></p>
                  <p class="listing-description"><%= truncate(listing.description, length: 100) if listing.description %></p>
                  <div class="listing-footer">
                    <span class="listing-price">
                      <% if listing.price %>
                        ‚Ç¨<%= number_with_delimiter(listing.price.to_i) %>
                      <% else %>
                        Price on request
                      <% end %>
                    </span>
                    <span class="btn-view">View</span>
                  </div>
                </div>
              <% end %>
              <% if user_signed_in? %>
                <% is_favorited = current_user.favorites.exists?(listing_id: listing.id) %>
                <% favorite = current_user.favorites.find_by(listing_id: listing.id) if is_favorited %>
                <div class="favorite-heart-container" data-listing-id="<%= listing.id %>" data-favorite-id="<%= favorite&.id %>">
                  <button class="favorite-heart-btn <%= 'favorite-heart-active' if is_favorited %>" 
                          data-listing-id="<%= listing.id %>"
                          data-favorited="<%= is_favorited %>"
                          title="<%= is_favorited ? 'Remove from favorites' : 'Add to favorites' %>">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="<%= is_favorited ? 'currentColor' : 'none' %>" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                  </button>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="empty-state">
          <p class="empty-message">No listings yet. Be the first to <%= link_to "post an ad", new_listing_path, class: "link" %>!</p>
        </div>
      <% end %>
    </div>
  </section>

  <!-- CTA Section (only show on homepage) -->
  <% unless params[:category_id].present? || params[:search].present? %>
  <section class="cta-section">
    <div class="container">
      <h2>Ready to sell something?</h2>
      <p>Post your ad for free - it only takes a minute!</p>
      <%= link_to "Post Your Ad Now", new_listing_path, class: "btn-cta" %>
    </div>
  </section>
  <% end %>
</div>
