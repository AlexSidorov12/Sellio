<% content_for :title, @listing.title %>

<% if notice %>
  <div class="alert alert-success"><%= notice %></div>
<% end %>

<div class="listing-detail">
  <div class="listing-detail-container">
    <!-- Images Section -->
    <div class="listing-images-section">
      <% if @listing.images.attached? %>
        <div class="main-image">
          <%= image_tag @listing.images.first, class: "listing-main-image" %>
        </div>
        <% if @listing.images.count > 1 %>
          <div class="thumbnail-images">
            <% @listing.images.each do |image| %>
              <%= image_tag image, class: "thumbnail-image" %>
            <% end %>
          </div>
        <% end %>
      <% else %>
        <div class="image-placeholder-large">
          <span>üì∑</span>
          <p>No images available</p>
        </div>
      <% end %>
    </div>

    <!-- Details Section -->
    <div class="listing-details-section">
      <div class="listing-header">
        <h1 class="listing-detail-title"><%= @listing.title %></h1>
        <div class="listing-meta">
          <% if @listing.category %>
            <span class="category-badge"><%= @listing.category.name %></span>
          <% end %>
          <span class="listing-date">Posted <%= time_ago_in_words(@listing.created_at) %> ago</span>
        </div>
      </div>

      <div class="listing-price-section">
        <span class="listing-price-large">
          <% if @listing.price %>
            ‚Ç¨<%= number_with_delimiter(@listing.price.to_i) %>
          <% else %>
            Price on request
          <% end %>
        </span>
      </div>

      <div class="listing-info">
        <div class="info-item">
          <strong>üìç Location:</strong>
          <span><%= @listing.city || "Not specified" %></span>
        </div>
        <% if @listing.user %>
          <div class="info-item">
            <strong>üë§ Seller:</strong>
            <span><%= @listing.user.name || @listing.user.email %></span>
          </div>
        <% end %>
      </div>

      <!-- Category-Specific Details (Motors) -->
      <% if @listing.category&.name == "Motors" && @listing.extra_fields.present? %>
        <div class="category-details">
          <h2>Vehicle Details</h2>
          <div class="details-grid">
            <% if @listing.make.present? || @listing.model.present? %>
              <div class="detail-item">
                <strong>Make & Model:</strong>
                <span><%= [@listing.make, @listing.model].compact.join(' ') %></span>
              </div>
            <% end %>
            <% if @listing.year.present? %>
              <div class="detail-item">
                <strong>Year:</strong>
                <span><%= @listing.year %></span>
              </div>
            <% end %>
            <% if @listing.mileage.present? %>
              <div class="detail-item">
                <strong>Mileage:</strong>
                <span><%= number_with_delimiter(@listing.mileage) %> km</span>
              </div>
            <% end %>
            <% if @listing.engine_size.present? %>
              <div class="detail-item">
                <strong>Engine Size:</strong>
                <span><%= @listing.engine_size %></span>
              </div>
            <% end %>
            <% if @listing.fuel_type.present? %>
              <div class="detail-item">
                <strong>Fuel Type:</strong>
                <span><%= @listing.fuel_type %></span>
              </div>
            <% end %>
            <% if @listing.transmission.present? %>
              <div class="detail-item">
                <strong>Transmission:</strong>
                <span><%= @listing.transmission %></span>
              </div>
            <% end %>
            <% if @listing.previous_owners.present? %>
              <div class="detail-item">
                <strong>Previous Owners:</strong>
                <span><%= @listing.previous_owners %></span>
              </div>
            <% end %>
            <% if @listing.license_plate.present? %>
              <div class="detail-item">
                <strong>License Plate:</strong>
                <span><%= @listing.license_plate %></span>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <div class="listing-description">
        <h2>Description</h2>
        <p><%= simple_format(@listing.description) %></p>
      </div>

      <div class="listing-actions">
        <% if user_signed_in? %>
          <% if current_user == @listing.user %>
            <%= link_to "Edit Listing", edit_listing_path(@listing), class: "btn-edit" %>
            <%= button_to "Delete Listing", @listing, method: :delete, 
                          data: { confirm: "Are you sure?" }, 
                          class: "btn-delete" %>
          <% elsif @listing.user %>
            <%= link_to "Contact Seller", new_message_path(listing_id: @listing.id, recipient_id: @listing.user.id), class: "btn-contact" %>
          <% end %>
        <% else %>
          <%= link_to "Login to Contact Seller", new_user_session_path, class: "btn-contact" %>
        <% end %>
        <%= link_to "Back to Listings", listings_path, class: "btn-back" %>
      </div>
    </div>
  </div>
</div>
